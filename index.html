<!doctype html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <style type="text/css">
        body, html, #container {
            height: 100%;
            margin: 0px;
        }

        #input {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 100px;
            height: 20px;
        }

        #search {
            position: absolute;
            top: 20px;
            left: 130px;
        }
    </style>
    <title>快速入门</title>
</head>
<body>
<div id="container" tabindex="0"></div>
<input id="input">
<button id="search">查询</button>
<div id="tip"></div>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.6&key=1f3aeb896a89af4b3a42a46de7c1d576"></script>
<script type="text/javascript">
    var map = new AMap.Map('container', {
        resizeEnable: true,
        zoom: 10,
        center: [116.480983, 40.0958]
    });

    var trans, station, linesearch;
    /*
     * 调用公交换乘服务
     */
    //加载公交换乘插件
    AMap.service(["AMap.Transfer"], function () {
        var transOptions = {
            map: map,
            city: '北京市',                            //公交城市
            //cityd:'乌鲁木齐',
            policy: AMap.TransferPolicy.LEAST_TIME //乘车策略
        };
        //构造公交换乘类
        trans = new AMap.Transfer(transOptions);

    });

    AMap.plugin(["AMap.StationSearch"], function () {
        //实例化公交站点查询类
        station = new AMap.StationSearch({
            pageIndex: 1, //页码
            pageSize: 1, //单页显示结果条数
            city: '010'    //确定搜索城市
        });
    });

    //加载公交线路查询插件
    //实例化公交线路查询类，只取回一条路线
    AMap.service(["AMap.LineSearch"], function () {
        linesearch = new AMap.LineSearch({
            pageIndex: 1,
            city: '北京',
            pageSize: 1,
            extensions: 'all'
        });
    })

    //根据起、终点坐标查询公交换乘路线
    document.getElementById('search').onclick = function () {
//        trans.search([{keyword:'北京市地震局(公交站)'},{keyword:'望京西园4区'}], function(status, result){
//        });
        let value = document.getElementById('input').value();
        stationSearch(value);

    };


    /*公交站点查询*/
    function stationSearch(name) {
        station.search(name, function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                stationSearch_CallBack(result);
            } else {
                alert(result);
            }
        });
    }

    /*公交站点查询返回数据解析*/
    function stationSearch_CallBack(searchResult) {
        var stationArr = searchResult.stationInfo;
        var searchNum = stationArr.length;
        if (searchNum > 0) {
//            document.getElementById('tip').innerHTML = '查询结果：共' + searchNum + '个站点';
            for (var i = 0; i < searchNum; i++) {
                var marker = new AMap.Marker({
                    position: stationArr[i].location,
                    map: map,
                    title: stationArr[i].name
                });
                marker.info = new AMap.InfoWindow({
                    content: stationArr[i].name,
                    offset: new AMap.Pixel(0, -30)
                });
                marker.on('click', function (e) {
                    e.target.info.open(map, e.target.getPosition())
                });
                var buslines = stationArr[i].buslines;
                for(let j =0,length = buslines.length; j<length;j++){
                    let busName = (buslines[j].name.split('('))[0];
                    lineSearch(busName)
                }

            }
            map.setFitView();
        }
    }

    function lineSearch(name) {
        linesearch.search(name, function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                lineSearch_Callback(result);
            } else {
                alert(result);
            }
        });
    }


    /*
     * 公交路线查询服务返回数据解析概况
     * param Array[]  lineArr     返回公交线路总数
     * param String   lineName    公交线路名称
     * param String   lineCity    公交所在城市
     * param String   company     公交所属公司
     * param Number   stime       首班车时间
     * param Number   etime       末班车时间
     * param Number   bprice      公交起步票价
     * param Number   tprice      公交全程票价
     * param Array[]  pathArr     公交线路路径数组
     */
    function lineSearch_Callback(data) {
        var lineArr = data.lineInfo;
        var lineNum = data.lineInfo.length;
        if (lineNum == 0) {
            resLine = data.info;
        }
        else {
            for (var i = 0; i < lineNum; i++) {
                var pathArr = lineArr[i].path;
                var stops = lineArr[i].via_stops;
                var startPot = stops[0].location;
                var endPot = stops[stops.length - 1].location;

                if (i == 0) drawbusLine(startPot, endPot, pathArr);
            }
        }
    }

    /*
     *绘制路线
     */
    function drawbusLine(startPot, endPot, BusArr) {
        //绘制起点，终点
        var stmarker = new AMap.Marker({
            map: map,
            position: [startPot.lng, startPot.lat], //基点位置
            icon: "https://webapi.amap.com/theme/v1.3/markers/n/start.png",
            zIndex: 10
        });
        var endmarker = new AMap.Marker({
            map: map,
            position: [endPot.lng, endPot.lat], //基点位置
            icon: "https://webapi.amap.com/theme/v1.3/markers/n/end.png",
            zIndex: 10
        });
        //绘制乘车的路线
        busPolyline = new AMap.Polyline({
            map: map,
            path: BusArr,
            strokeColor: "#09f",//线颜色
            strokeOpacity: 0.8,//线透明度
            strokeWeight: 6//线宽
        });
        map.setFitView();
    }

</script>
</body>
</html>